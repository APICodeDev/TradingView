//@version=5
indicator("Multi-Factor Crypto Entry Indicator", overlay=true, max_lines_count=500, max_labels_count=500)

// Input parameters for user customization
// Trend Analysis Settings
trend_length = input.int(20, "Trend Length", minval=1)
trend_ma_type = input.string("EMA", "Trend MA Type", options=["SMA", "EMA", "RMA", "WMA"])

// Support and Resistance Settings
sr_length = input.int(50, "Support/Resistance Length", minval=1)
sr_tolerance = input.float(0.005, "S/R Tolerance", minval=0.0001, step=0.0001, tooltip="Percentage tolerance for support/resistance zones")

// Volume Analysis Settings
volume_ma_length = input.int(20, "Volume MA Length", minval=1)
volume_threshold = input.float(1.5, "Volume Threshold", minval=1.0, step=0.1, tooltip="Multiplier for average volume to consider high volume")

// Candlestick Pattern Settings
doji_threshold = input.float(0.1, "Doji Body Threshold", minval=0.01, step=0.01, tooltip="Maximum body size as % of range to be considered a doji")
engulfing_ratio = input.float(1.1, "Engulfing Ratio", minval=1.0, step=0.1, tooltip="Minimum ratio for engulfing patterns")

// Profit Settings
min_profit_target = input.float(2.0, "Minimum Profit Target %", minval=0.1, step=0.1)
profit_distance = input.float(0.5, "Profit Target Distance Factor", minval=0.1, step=0.1, tooltip="Factor to determine profit target based on volatility")

// Timeframe Analysis Settings
higher_tf = input.timeframe("240", "Higher Timeframe for Trend", options=["", "30", "60", "120", "240", "D", "W"])

// Visual Settings
show_labels = input.bool(true, "Show Entry Labels")
show_tp_lines = input.bool(true, "Show Take Profit Lines")
buy_color = input.color(color.green, "Buy Signal Color")
sell_color = input.color(color.red, "Sell Signal Color")
tp_color = input.color(color.blue, "Take Profit Line Color")

// Function to calculate moving average based on user selection
ma(src, length) =>
    switch trend_ma_type
        "SMA" => ta.sma(src, length)
        "EMA" => ta.ema(src, length)
        "RMA" => ta.rma(src, length)
        "WMA" => ta.wma(src, length)

// Trend Analysis
trend_ma = ma(close, trend_length)
trend_up = close > trend_ma
trend_down = close < trend_ma

// Higher timeframe trend analysis
var float higher_trend = na
var float higher_trend_value = na
if higher_tf != ""
    [h_close, h_open] = request.security(syminfo.tickerid, higher_tf, [close, open], lookahead=barmerge.lookahead_off)
    higher_trend := h_close > ma(h_close, trend_length)
    higher_trend_value := ma(h_close, trend_length)

// Support and Resistance Levels
var float highest_high = na
var float lowest_low = na
highest_high := ta.highest(high, sr_length)
lowest_low := ta.lowest(low, sr_length)

// Check if price is near support or resistance
is_near_resistance = math.abs(close - highest_high) / close <= sr_tolerance
is_near_support = math.abs(close - lowest_low) / close <= sr_tolerance

// Volume Analysis
volume_ma = ta.sma(volume, volume_ma_length)
high_volume = volume > volume_ma * volume_threshold

// Candlestick Pattern Recognition
body_size = math.abs(close - open)
upper_shadow = high - math.max(close, open)
lower_shadow = math.min(close, open) - low
candle_range = high - low

// Doji Pattern
is_doji = body_size / candle_range <= doji_threshold

// Bullish Engulfing
is_bullish_engulfing = close > open and close[1] < open[1] and close > open[1] and close[1] < open

// Bearish Engulfing
is_bearish_engulfing = close < open and close[1] > open[1] and close < open[1] and close[1] > open

// Hammer Pattern
is_hammer = lower_shadow > body_size * 2 and upper_shadow < body_size
is_hanging_man = is_hammer and trend_up

// Shooting Star Pattern
is_shooting_star = upper_shadow > body_size * 2 and lower_shadow < body_size
is_inverted_hammer = is_shooting_star and trend_down

// Calculate volatility for profit targets
atr_value = ta.atr(14)
profit_target_up = close * (1 + min_profit_target / 100)
profit_target_down = close * (1 - min_profit_target / 100)

// Determine if we're in an impulse high/low zone
// Looking for significant price levels with high volume
var float impulse_high = na
var float impulse_low = na
impulse_high := ta.highest(high, 10)[1]  // Previous high as potential resistance
impulse_low := ta.lowest(low, 10)[1]     // Previous low as potential support

// Check for potential buy/sell signals
buy_signal = false
sell_signal = false

// Buy conditions: near support, bullish candlestick, high volume, uptrend
if is_near_support and (is_bullish_engulfing or is_doji or is_hammer) and high_volume and (trend_up or (higher_tf != "" and higher_trend))
    buy_signal := true

// Sell conditions: near resistance, bearish candlestick, high volume, downtrend
if is_near_resistance and (is_bearish_engulfing or is_doji or is_hanging_man or is_shooting_star) and high_volume and (trend_down or (higher_tf != "" and not higher_trend))
    sell_signal := true

// Additional confirmation: Check for impulse moves
// Buy when price is near recent low with high volume and bullish patterns
if low <= impulse_low * (1 + sr_tolerance) and high_volume and (is_bullish_engulfing or is_hammer or is_doji)
    buy_signal := true

// Sell when price is near recent high with high volume and bearish patterns
if high >= impulse_high * (1 - sr_tolerance) and high_volume and (is_bearish_engulfing or is_hanging_man or is_shooting_star)
    sell_signal := true

// Plotting
plotshape(buy_signal and show_labels, style=shape.labelup, location=location.belowbar, color=buy_color, size=size.normal, text="BUY", textcolor=color.white)
plotshape(sell_signal and show_labels, style=shape.labeldown, location=location.abovebar, color=sell_color, size=size.normal, text="SELL", textcolor=color.white)

// Draw take profit lines
var line tp_line = na
var label tp_label = na

if buy_signal and show_tp_lines
    // Calculate take profit based on volatility and minimum target
    actual_tp = math.max(profit_target_up, close * (1 + min_profit_target / 100))
    tp_line := line.new(bar_index, actual_tp, bar_index + 10, actual_tp, color=tp_color, width=1)
    tp_label := label.new(bar_index, actual_tp, text="TP: " + str.tostring(actual_tp, "#.##"), color=tp_color, textcolor=color.white, style=label.style_label_down, size=size.small)

if sell_signal and show_tp_lines
    // Calculate take profit based on volatility and minimum target
    actual_tp = math.min(profit_target_down, close * (1 - min_profit_target / 100))
    tp_line := line.new(bar_index, actual_tp, bar_index + 10, actual_tp, color=tp_color, width=1)
    tp_label := label.new(bar_index, actual_tp, text="TP: " + str.tostring(actual_tp, "#.##"), color=tp_color, textcolor=color.white, style=label.style_label_up, size=size.small)

// Plot support and resistance levels
plot(is_near_resistance ? highest_high : na, color=color.red, linewidth=1, title="Resistance")
plot(is_near_support ? lowest_low : na, color=color.green, linewidth=1, title="Support")

// Background color for trend
bgcolor(trend_up ? color.new(color.green, 95) : (trend_down ? color.new(color.red, 95) : na), title="Trend Background")

// Alerts
alertcondition(buy_signal, title="Buy Signal", message="Multi-Factor Crypto Indicator: BUY signal detected!")
alertcondition(sell_signal, title="Sell Signal", message="Multi-Factor Crypto Indicator: SELL signal detected!")

// Display information on chart
var table info_table = table.new(position.top_right, 2, 6, bgcolor=color.white, border_width=1)
if barstate.islast
    table.cell(info_table, 0, 0, "Trend:", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 0, trend_up ? "UP" : trend_down ? "DOWN" : "NEUTRAL", text_color=color.white, bgcolor=trend_up ? color.green : trend_down ? color.red : color.gray)
    
    table.cell(info_table, 0, 1, "Volume:", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 1, high_volume ? "HIGH" : "NORMAL", text_color=color.white, bgcolor=high_volume ? color.orange : color.blue)
    
    table.cell(info_table, 0, 2, "Near S/R:", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 2, is_near_resistance ? "RESISTANCE" : is_near_support ? "SUPPORT" : "NO", text_color=color.white, bgcolor=is_near_resistance ? color.red : is_near_support ? color.green : color.gray)
    
    table.cell(info_table, 0, 3, "Patterns:", text_color=color.black, bgcolor=color.gray)
    pattern_text = ""
    if is_bullish_engulfing
        pattern_text := pattern_text + "BullEng "
    if is_bearish_engulfing
        pattern_text := pattern_text + "BearEng "
    if is_doji
        pattern_text := pattern_text + "Doji "
    if is_hammer
        pattern_text := pattern_text + "Hammer "
    if is_hanging_man
        pattern_text := pattern_text + "Hanging "
    if is_shooting_star
        pattern_text := pattern_text + "ShootStar "
    table.cell(info_table, 1, 3, pattern_text == "" ? "None" : pattern_text, text_color=color.white, bgcolor=pattern_text != "" ? color.yellow : color.gray)
    
    table.cell(info_table, 0, 4, "Min Profit:", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 4, str.tostring(min_profit_target) + "%", text_color=color.white, bgcolor=color.blue)
    
    table.cell(info_table, 0, 5, "Signal:", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 5, buy_signal ? "BUY" : sell_signal ? "SELL" : "NONE", text_color=color.white, bgcolor=buy_signal ? color.green : sell_signal ? color.red : color.gray)